---
import { getRelativeLocaleUrl } from "astro:i18n";
import { useTranslations } from "../i18n/utils";
import { languageList } from "../i18n/ui";
import LanguageToggle from "./LanguageToggle.astro";

type Lang = keyof typeof languageList;

const currentLang = (Astro.currentLocale ?? "es") as Lang;
const translateLabels = useTranslations(currentLang);

const navItems = [
  {
    title: translateLabels("header.experience"),
    label: "experiencia",
    url: "#experiencia",
  },
  {
    title: translateLabels("header.projects"),
    label: "proyectos",
    url: "#proyectos",
  },
  {
    title: translateLabels("header.certificates"),
    label: "certificados",
    url: "#certificados",
  },

  {
    title: translateLabels("header.aboutme"),
    label: "sobre-mi",
    url: "#sobre-mi",
  },
  {
    title: translateLabels("header.contact"),
    label: "contacto",
    url: "mailto:sebastian.becerra.durand@gmail.com",
  },
];
---

<header class="fixed top-0 z-20 w-full mx-auto mt-2" data-main-header>
  {}
  <nav
    data-desktop-nav
    class="flex px-3 py-2 text-sm font-medium rounded-full text-gray-600 dark:text-gray-200 justify-center items-center bg-white/50 dark:bg-gray-800/90 max-w-fit mx-auto shadow-md backdrop-blur-lg"
  >
    {
      navItems.map((link) => (
        <a
          class="relative block px-3 py-2 transition hover:text-blue-500 dark:hover:text-blue-500"
          aria-label={link.label}
          href={link.url}
        >
          {link.title}
        </a>
      ))
    }

    <LanguageToggle />
  </nav>

  {}
  <div class="mobile-nav-wrapper" data-mobile-nav>
    <div class="nav-shell-mobile" data-mobile-shell>
      <div
        class="mx-auto flex max-w-screen-xl flex-wrap items-center justify-between px-4 py-3"
      >
        {/* Botón hamburguesa */}
        <button
          class="menu-toggle"
          aria-label="Abrir menú"
          aria-expanded="false"
          data-menu-toggle
        >
          <span></span><span></span><span></span>
        </button>

        {/* “Logo” / título */}
        <a
          href="#hero"
          class="flex items-center gap-2"
          aria-label="Ir al inicio"
        >
          <span class="text-lg font-semibold text-white">SebastianDev</span>
        </a>

        {/* Panel desplegable */}
        <div class="nav-panel-mobile" data-menu>
          <ul class="menu-mobile">
            {
              navItems.map((link) => (
                <li class="menu-item-mobile">
                  <a
                    href={link.url}
                    aria-label={link.label}
                    class="menu__link-mobile"
                  >
                    {link.title}
                  </a>
                </li>
              ))
            }

            {/* Idioma alineado a la izquierda y a ancho completo */}
            <li class="menu-item-mobile mt-2 border-t border-white/10 pt-2">
              <div class="w-full flex justify-start">
                <LanguageToggle />
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<script is:inline>
  document.addEventListener("astro:page-load", () => {
    /* ====== RESALTAR LINKS EN DESKTOP CON SCROLL (TU EFECTO ORIGINAL) ====== */
    const sections = document.querySelectorAll("section");
    const desktopNavLinks = document.querySelectorAll(
      "nav[data-desktop-nav] a"
    );

    const ioCallback = (entries) => {
      entries.forEach((entry) => {
        if (!entry.isIntersecting) return;
        desktopNavLinks.forEach((item) => {
          if (item.getAttribute("aria-label") === entry.target.id) {
            item.classList.add("text-blue-500");
          } else {
            item.classList.remove("text-blue-500");
          }
        });
      });
    };

    const observer = new IntersectionObserver(ioCallback, {
      root: null,
      rootMargin: "0px",
      threshold: 0.3,
    });

    sections.forEach((section) => observer.observe(section));

    document.onvisibilitychange = () => {
      if (document.visibilityState === "hidden") {
        observer.disconnect();
      } else {
        sections.forEach((section) => observer.observe(section));
      }
    };

    /* ====== LÓGICA MENÚ MÓVIL ====== */
    const shell = document.querySelector("[data-mobile-shell]");
    const menu = document.querySelector("[data-menu]");
    const btn = document.querySelector("[data-menu-toggle]");

    if (!btn || !menu) return;

    // Que el header no se vea transparente al inicio
    shell?.classList.add("glass");

    const toggleMenu = () => {
      const opened = menu.classList.toggle("open");
      btn.classList.toggle("active", opened);
      btn.setAttribute("aria-expanded", String(opened));
      shell?.classList.toggle("glass", opened || window.scrollY > 8);
    };

    btn.addEventListener("click", (ev) => {
      ev.stopPropagation();
      toggleMenu();
    });

    // Cerrar al hacer click fuera
    document.addEventListener("click", (ev) => {
      if (!btn.contains(ev.target) && !menu.contains(ev.target)) {
        menu.classList.remove("open");
        btn.classList.remove("active");
        btn.setAttribute("aria-expanded", "false");
        shell?.classList.add("glass");
      }
    });

    // Scroll suave para los links del menú móvil
    const mobileLinks = document.querySelectorAll(".menu__link-mobile");
    mobileLinks.forEach((a) => {
      a.addEventListener("click", (ev) => {
        const href = a.getAttribute("href") || "";
        if (!href.includes("#")) return;

        const id = href.slice(href.indexOf("#"));
        const target = document.querySelector(id);
        if (!target) return;

        ev.preventDefault();

        menu.classList.remove("open");
        btn.classList.remove("active");
        btn.setAttribute("aria-expanded", "false");

        target.scrollIntoView({ behavior: "smooth", block: "start" });
      });
    });
  });
</script>

<style>
  @reference "tailwindcss";

  /* ===== DESKTOP NAV (CENTRADO, COMO LO TENÍAS) ===== */
  nav[data-desktop-nav] {
    animation: nav-shadow 1s linear both;
    animation-timeline: scroll();
    animation-range: 0 100px;
  }

  @keyframes nav-shadow {
    to {
      box-shadow:
        0 10px 15px -3px rgb(0 0 0 / 0.1),
        0 4px 6px -4px rgb(0 0 0 / 0.1),
        0 0 0 1px rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
  }

  /* ===== NAV MÓVIL ===== */
  [data-mobile-nav] {
    display: none;
  }

  @media (max-width: 768px) {
    /* quita el margen superior para evitar el hueco rojo */
    [data-main-header] {
      margin-top: 0;
    }

    nav[data-desktop-nav] {
      display: none;
    }
    [data-mobile-nav] {
      display: block;
    }
  }

  .nav-shell-mobile {
    border-radius: 0;
    padding: 0.35rem 0.75rem;
    background: rgb(0 0 0 / 85%);
    backdrop-filter: blur(10px);
  }

  .nav-shell-mobile.glass {
    background: rgb(0 0 0 / 85%);
  }

  .mobile-nav-wrapper {
    @apply text-white;
  }

  /* Botón hamburguesa */
  .menu-toggle {
    display: flex;
    width: 26px;
    height: 20px;
    padding: 0;
    border: 0;
    background: transparent;
    cursor: pointer;
    align-items: center;
    justify-content: space-between;
    flex-direction: column;
  }
  .menu-toggle span {
    width: 100%;
    height: 3px;
    background: white;
    border-radius: 10px;
    transition: all 0.3s;
  }
  .menu-toggle.active span:nth-child(1) {
    transform: rotate(45deg) translateY(7px);
  }
  .menu-toggle.active span:nth-child(2) {
    opacity: 0;
  }
  .menu-toggle.active span:nth-child(3) {
    transform: rotate(-45deg) translateY(-7px);
  }

  /* Panel desplegable */
  .nav-panel-mobile {
    width: 100%;
    background: rgb(0 0 0 / 95%);
    transform: translateY(-160%);
    opacity: 0;
    pointer-events: none;
    transition:
      transform 0.35s ease,
      opacity 0.35s ease;
    position: absolute;
    top: 60px; /* altura aprox. del header en móvil */
    left: 0;
  }

  .nav-panel-mobile.open {
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto;
  }

  /* Lista y enlaces alineados a la izquierda */
  .menu-mobile {
    list-style: none;
    padding: 0.75rem 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    align-items: stretch; /* para que los li ocupen todo el ancho */
  }

  .menu-item-mobile {
    width: 100%;
  }

  .menu__link-mobile {
    display: block;
    width: 100%;
    padding: 0.6rem 1rem;
    color: #e5e7eb;
    text-align: left;
    font-size: 1rem;
    text-decoration: none;
    font-weight: 500;
    transition:
      background 0.15s,
      color 0.15s;
  }

  .menu__link-mobile:hover {
    background: rgba(148, 163, 184, 0.15);
    color: #38bdf8;
  }
</style>
